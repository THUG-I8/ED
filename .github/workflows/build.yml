name: ğŸ—ï¸ Build APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ¦ Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.9'
        channel: 'stable'
        
    - name: ğŸ“¦ Get dependencies
      run: flutter pub get
      
    - name: ğŸ”§ Build APK
      run: flutter build apk --release --target-platform android-arm64 --split-per-abi
      
    - name: ğŸ”§ Build APK for weak devices
      run: flutter build apk --release --target-platform android-arm --split-per-abi
      
    - name: ğŸ·ï¸ Get version
      id: version
      run: echo "version=$(grep 'version:' pubspec.yaml | cut -d ' ' -f 2 | cut -d '+' -f 1)" >> $GITHUB_OUTPUT
      
    - name: ğŸ“¤ Upload APK (ARM64)
      uses: actions/upload-artifact@v4
      with:
        name: know-your-deen-v${{ steps.version.outputs.version }}-arm64
        path: build/app/outputs/flutter-apk/app-arm64-release.apk
        
    - name: ğŸ“¤ Upload APK (ARM - Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø¶Ø¹ÙŠÙØ©)
      uses: actions/upload-artifact@v4
      with:
        name: know-your-deen-v${{ steps.version.outputs.version }}-arm
        path: build/app/outputs/flutter-apk/app-arm-release.apk
        
    - name: ğŸš€ Create Release
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}-${{ github.run_number }}
        name: Ø§Ø¹Ø±Ù Ø¯ÙŠÙ†Ùƒ v${{ steps.version.outputs.version }}
        body: |
          ## ğŸŒŸ ØªØ·Ø¨ÙŠÙ‚ Ø§Ø¹Ø±Ù Ø¯ÙŠÙ†Ùƒ - Ø¥ØµØ¯Ø§Ø± Ø¬Ø¯ÙŠØ¯
          
          ### âœ¨ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:
          - ğŸ“– Ù‚ØµØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ© ÙŠÙˆÙ…ÙŠØ©
          - ğŸ“¿ Ø³Ø¨Ø­Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© Ø°ÙƒÙŠØ©  
          - ğŸ• Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©
          - ğŸ§­ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Ø¨Ù„Ø©
          - ğŸŒ™ Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­ ÙˆØ§Ù„Ù…Ø³Ø§Ø¡
          - ğŸ¨ ØªØµÙ…ÙŠÙ… Ø¥Ø³Ù„Ø§Ù…ÙŠ Ø¬Ù…ÙŠÙ„
          
          ### ğŸ“± Ø§Ù„ØªØ­Ù…ÙŠÙ„:
          - **Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø­Ø¯ÙŠØ«Ø© (ARM64)**: Ø­Ù…Ù„ `app-arm64-release.apk`
          - **Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø¶Ø¹ÙŠÙØ© ÙˆØ§Ù„Ù‚Ø¯ÙŠÙ…Ø© (ARM)**: Ø­Ù…Ù„ `app-arm-release.apk`
          
          ### ğŸ”’ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø£Ù…Ø§Ù†:
          Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„ØªÙØ¹ÙŠÙ„ "ØªØ«Ø¨ÙŠØª Ù…Ù† Ù…ØµØ§Ø¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©" ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
          
          ### ğŸ“Š ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡:
          - âœ… Ù…Ø­Ø³Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø¶Ø¹ÙŠÙØ©
          - âœ… ÙŠØ¯Ø¹Ù… Android 5.0 ÙˆÙ…Ø§ ÙÙˆÙ‚
          - âœ… Ø­Ø¬Ù… Ù…Ù„ÙØ§Øª Ù…Ø­Ø³Ù†
          - âœ… Ø£Ø¯Ø§Ø¡ Ù…Ø­Ø³Ù† Ù„Ù„Ø°Ø§ÙƒØ±Ø©
          
          ---
          **Ø¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠÙƒÙ… ÙˆÙ†ÙØ¹ Ø¨Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ğŸ¤²**
        files: |
          build/app/outputs/flutter-apk/app-arm64-release.apk
          build/app/outputs/flutter-apk/app-arm-release.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}